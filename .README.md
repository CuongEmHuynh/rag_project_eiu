# Xử lý ảnh về đen tối -> bỏ mộc đỏ
def ocr_page_vietocr(
    pil_img: Image.Image,
    processed_debug_dir: Optional[str] = None,
    page_label: Optional[str] = None,
    window_debug_dir: Optional[str] = None,
):
    processed = preprocess_image(
        pil_img,
        debug_dir=processed_debug_dir,
        debug_label=page_label,
    )
    text = vietocr.predict(processed)

    normalized = text.strip()
    if normalized and normalized != "1" and len(normalized) >= VIETOCR_MIN_RESULT_LENGTH:
        return text

    print("[VietOCR] Kết quả quá ngắn, sử dụng fallback sliding-window.")
    # return fallback_text if fallback_text.strip() else text


def preprocess_image(
    pil_img: Image.Image,
    debug_dir: Optional[str] = None,
    debug_label: Optional[str] = None,
):
    import cv2
    import numpy as np

    img = np.array(pil_img)

    # Bảo đảm ảnh ở dạng 3 kênh RGB
    if img.ndim == 3 and img.shape[2] == 4:
        img = cv2.cvtColor(img, cv2.COLOR_RGBA2RGB)
    elif img.ndim == 2:
        img = cv2.cvtColor(img, cv2.COLOR_GRAY2RGB)

    bgr = cv2.cvtColor(img, cv2.COLOR_RGB2BGR)

    # 1. Khử màu đỏ của con dấu bằng mask HSV + inpaint
    hsv = cv2.cvtColor(bgr, cv2.COLOR_BGR2HSV)
    lower_red1 = np.array([0, 70, 50])
    upper_red1 = np.array([10, 255, 255])
    lower_red2 = np.array([170, 70, 50])
    upper_red2 = np.array([180, 255, 255])
    mask = cv2.inRange(hsv, lower_red1, upper_red1) | cv2.inRange(hsv, lower_red2, upper_red2)
    mask = cv2.morphologyEx(mask, cv2.MORPH_DILATE, np.ones((3, 3), np.uint8), iterations=1)
    clean = cv2.inpaint(bgr, mask, 3, cv2.INPAINT_TELEA)

    # 2. Grayscale + giảm nhiễu nhẹ
    gray = cv2.cvtColor(clean, cv2.COLOR_BGR2GRAY)
    gray = cv2.GaussianBlur(gray, (3, 3), 0)

    # 3. Tăng tương phản cục bộ bằng adaptive threshold
    adaptive = cv2.adaptiveThreshold(
        gray, 255,
        cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
        cv2.THRESH_BINARY,
        35,
        10
    )

    # 4. Làm sạch nét chữ
    kernel = np.ones((2, 2), np.uint8)
    opened = cv2.morphologyEx(adaptive, cv2.MORPH_OPEN, kernel, iterations=1)

    processed_img = Image.fromarray(opened).convert("RGB")

    if debug_dir:
        os.makedirs(debug_dir, exist_ok=True)
        filename = f"{debug_label}_processed.png" if debug_label else f"processed_{uuid.uuid4().hex}.png"
        processed_img.save(os.path.join(debug_dir, filename))

    return processed_img